---
import yaml from 'js-yaml'
import fs from 'node:fs'
import path from 'node:path'
import '../styles/resume.css'
import type { CVData } from '../types/cv-data'
import BasicInfo from '../components/cv/BasicInfo.astro'
import Career from '../components/cv/Career.astro'
import Skills from '../components/cv/Skills.astro'
import AITools from '../components/cv/AITools.astro'
import Strengths from '../components/cv/Strengths.astro'
import AIAnalysis from '../components/cv/AIAnalysis.astro'
import WorkExperience from '../components/cv/WorkExperience.astro'
import OSSContributions from '../components/cv/OSSContributions.astro'
import PersonalProjects from '../components/cv/PersonalProjects.astro'
import NetworkDiagram from '../components/cv/NetworkDiagram.astro'
import Others from '../components/cv/Others.astro'

// Load CV data from YAML
const yamlPath = path.join(process.cwd(), 'src/data/cv-data.yaml')
const yamlContent = fs.readFileSync(yamlPath, 'utf-8')
const cvData = yaml.load(yamlContent) as CVData
---

<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>{cvData.meta.title}</title>
    <meta name="description" content={cvData.meta.description} />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/css/all.min.css" />
  </head>
  <body>
    <script is:inline>
      ;(function () {
        const saved = localStorage.getItem('theme')
        const theme =
          saved ||
          (window.matchMedia('(prefers-color-scheme: dark)').matches
            ? 'dark'
            : 'light')
        document.body.setAttribute('data-theme', theme)
      })()
    </script>

    <div class="theme-toggle">
      <button
        id="theme-btn"
        class="toggle-btn"
        type="button"
        aria-label="Toggle dark mode"
      >
        ðŸŒ™
      </button>
      <button
        id="pdf-btn"
        class="toggle-btn"
        type="button"
        aria-label="Toggle PDF layout"
        aria-pressed="false"
      >
        PDF
      </button>
    </div>

    <main class="container">
      <header class="header">
        <h1>Curriculum-Vitae</h1>
        <p class="update-date">{cvData.meta.updateDate}</p>
      </header>

      <BasicInfo data={cvData.basicInfo} />
      <Career data={cvData.career} />
      <Skills data={cvData.skills} />
      <AITools data={cvData.aiTools} />
      <Strengths data={cvData.strengths} />
      <AIAnalysis data={cvData.aiAnalysis} />
      <WorkExperience data={cvData.workExperience} />
      <OSSContributions data={cvData.ossContributions} />
      <PersonalProjects data={cvData.personalProjects} />
      <NetworkDiagram data={cvData.networkDiagram} />
      <Others data={cvData.others} />
    </main>

    <script>
      // --- Mermaid: é…å»¶èª­ã¿è¾¼ã¿ + ãƒ†ãƒ¼ãƒžé€£å‹• ---
      const mermaidFlowchart = {
        htmlLabels: true,
        curve: 'cardinal',
      }

      const getMermaidTheme = () => {
        if (document.body.getAttribute('data-layout') === 'pdf') {
          return 'default'
        }
        return document.body.getAttribute('data-theme') === 'dark'
          ? 'dark'
          : 'default'
      }

      let mermaidModule = null
      let currentMermaidTheme = null

      // æç”»å‰ã«ã‚ªãƒªã‚¸ãƒŠãƒ«å®šç¾©ã‚’ä¿å­˜
      const mermaidElements = document.querySelectorAll('.mermaid')
      const originalDefinitions = new Map()
      mermaidElements.forEach((el) => {
        originalDefinitions.set(el, el.textContent?.trim() || '')
      })

      const renderMermaid = async () => {
        if (!mermaidModule) {
          const m = await import('mermaid')
          mermaidModule = m.default
        }

        const theme = getMermaidTheme()
        // ãƒ†ãƒ¼ãƒžãŒå¤‰ã‚ã£ãŸã¨ãã ã‘ initialize ã‚’å‘¼ã¶
        if (theme !== currentMermaidTheme) {
          currentMermaidTheme = theme
          mermaidModule.initialize({
            startOnLoad: false,
            theme,
            flowchart: mermaidFlowchart,
          })
        }

        // æç”»æ¸ˆã¿ã®å ´åˆã®ã¿ SVG ã‚’ã‚¯ãƒªã‚¢ã—ã¦å†æç”»
        mermaidElements.forEach((el) => {
          const original = originalDefinitions.get(el)
          if (original && el.querySelector('svg')) {
            el.removeAttribute('data-processed')
            el.innerHTML = original
          }
        })

        await mermaidModule.run()
      }

      // IntersectionObserver ã§ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆä»˜è¿‘ã«æ¥ãŸã‚‰èª­ã¿è¾¼ã¿
      let mermaidInitiated = false
      if (mermaidElements.length > 0) {
        const observer = new IntersectionObserver(
          (entries) => {
            for (const entry of entries) {
              if (entry.isIntersecting && !mermaidInitiated) {
                mermaidInitiated = true
                observer.disconnect()
                renderMermaid()
              }
            }
          },
          { rootMargin: '200px' },
        )
        mermaidElements.forEach((el) => observer.observe(el))
      }

      const reRenderMermaid = async () => {
        if (!mermaidModule) return
        await renderMermaid()
      }

      // --- ãƒ†ãƒ¼ãƒžãƒ»PDFãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåˆ¶å¾¡ ---
      ;(function () {
        const themeBtn = document.getElementById('theme-btn')
        const pdfBtn = document.getElementById('pdf-btn')
        const body = document.body
        let printLayoutForced = false

        if (!themeBtn) {
          console.error('Theme button not found')
          return
        }

        // ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ç¾åœ¨ã®ãƒ†ãƒ¼ãƒžã«åˆã‚ã›ã‚‹ï¼ˆãƒ†ãƒ¼ãƒžè‡ªä½“ã¯ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§è¨­å®šæ¸ˆã¿ï¼‰
        themeBtn.textContent =
          body.getAttribute('data-theme') === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™'

        const setPdfButtonState = (enabled) => {
          if (!pdfBtn) return
          pdfBtn.setAttribute('aria-pressed', enabled ? 'true' : 'false')
        }

        const applyPdfLayout = (enabled) => {
          if (enabled) {
            body.setAttribute('data-layout', 'pdf')
          } else {
            body.removeAttribute('data-layout')
          }
          setPdfButtonState(enabled)
        }

        // PDFãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®å¾©å…ƒ
        const savedLayout = localStorage.getItem('pdf-layout')
        if (savedLayout === 'enabled') {
          applyPdfLayout(true)
        } else {
          setPdfButtonState(false)
        }

        themeBtn.addEventListener('click', () => {
          const currentTheme = body.getAttribute('data-theme')
          const newTheme = currentTheme === 'dark' ? 'light' : 'dark'

          body.setAttribute('data-theme', newTheme)
          themeBtn.textContent = newTheme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™'
          localStorage.setItem('theme', newTheme)

          reRenderMermaid()
        })

        if (pdfBtn) {
          pdfBtn.addEventListener('click', () => {
            const isPdfLayout = body.getAttribute('data-layout') === 'pdf'
            const nextState = !isPdfLayout

            applyPdfLayout(nextState)
            localStorage.setItem(
              'pdf-layout',
              nextState ? 'enabled' : 'disabled',
            )
            reRenderMermaid()
          })
        } else {
          console.error('PDF button not found')
        }

        window.addEventListener('beforeprint', () => {
          if (body.getAttribute('data-layout') !== 'pdf') {
            applyPdfLayout(true)
            printLayoutForced = true
          }
          // best-effort: å°åˆ·ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒéžåŒæœŸå®Œäº†ã‚’å¾…ãŸãªã„å ´åˆãŒã‚ã‚‹
          reRenderMermaid()
        })

        window.addEventListener('afterprint', () => {
          if (printLayoutForced) {
            applyPdfLayout(false)
            printLayoutForced = false
          }
          reRenderMermaid()
        })
      })()
    </script>
  </body>
</html>
