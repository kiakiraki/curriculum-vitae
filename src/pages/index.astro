---
import yaml from 'js-yaml'
import fs from 'node:fs'
import path from 'node:path'
import '../styles/resume.css'
import type { CVData } from '../types/cv-data'
import BasicInfo from '../components/cv/BasicInfo.astro'
import Career from '../components/cv/Career.astro'
import Skills from '../components/cv/Skills.astro'
import AITools from '../components/cv/AITools.astro'
import Strengths from '../components/cv/Strengths.astro'
import AIAnalysis from '../components/cv/AIAnalysis.astro'
import WorkExperience from '../components/cv/WorkExperience.astro'
import OSSContributions from '../components/cv/OSSContributions.astro'
import PersonalProjects from '../components/cv/PersonalProjects.astro'
import NetworkDiagram from '../components/cv/NetworkDiagram.astro'
import Others from '../components/cv/Others.astro'

// Load CV data from YAML
const yamlPath = path.join(process.cwd(), 'src/data/cv-data.yaml')
const yamlContent = fs.readFileSync(yamlPath, 'utf-8')
const cvData = yaml.load(yamlContent) as CVData
---

<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>{cvData.meta.title}</title>
    <meta name="description" content={cvData.meta.description} />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Source+Sans+3:wght@400;600&family=Noto+Sans+JP:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/css/all.min.css" />
  </head>
  <body>
    <script is:inline>
      ;(function () {
        const mode = localStorage.getItem('theme-mode') || 'auto'
        let theme
        if (mode === 'auto') {
          theme = window.matchMedia('(prefers-color-scheme: dark)').matches
            ? 'dark'
            : 'light'
        } else {
          theme = mode
        }
        document.body.setAttribute('data-theme', theme)
        document.body.setAttribute('data-theme-mode', mode)
      })()
    </script>

    <div class="orb-purple"></div>

    <div class="theme-toggle">
      <button
        id="theme-btn"
        class="toggle-btn"
        type="button"
        aria-label="Toggle theme"
      >
        üñ•Ô∏è
      </button>
      <button
        id="pdf-btn"
        class="toggle-btn"
        type="button"
        aria-label="Toggle PDF layout"
        aria-pressed="false"
      >
        PDF
      </button>
    </div>

    <main class="container">
      <header class="header">
        <h1>Curriculum-Vitae</h1>
        <p class="update-date">{cvData.meta.updateDate}</p>
      </header>

      <BasicInfo data={cvData.basicInfo} />
      <Career data={cvData.career} />
      <Skills data={cvData.skills} />
      <AITools data={cvData.aiTools} />
      <Strengths data={cvData.strengths} />
      <AIAnalysis data={cvData.aiAnalysis} />
      <WorkExperience data={cvData.workExperience} />
      <OSSContributions data={cvData.ossContributions} />
      <PersonalProjects data={cvData.personalProjects} />
      <NetworkDiagram data={cvData.networkDiagram} />
      <Others data={cvData.others} />
    </main>

    <script>
      // --- Mermaid: ÈÅÖÂª∂Ë™≠„ÅøËæº„Åø + „ÉÜ„Éº„ÉûÈÄ£Âãï ---
      const mermaidFlowchart = {
        htmlLabels: true,
        curve: 'cardinal',
      }

      const getMermaidTheme = () => {
        if (document.body.getAttribute('data-layout') === 'pdf') {
          return 'default'
        }
        return document.body.getAttribute('data-theme') === 'dark'
          ? 'dark'
          : 'default'
      }

      let mermaidModule = null
      let currentMermaidTheme = null

      // ÊèèÁîªÂâç„Å´„Ç™„É™„Ç∏„Éä„É´ÂÆöÁæ©„Çí‰øùÂ≠ò
      const mermaidElements = document.querySelectorAll('.mermaid')
      const originalDefinitions = new Map()
      mermaidElements.forEach((el) => {
        originalDefinitions.set(el, el.textContent?.trim() || '')
      })

      const renderMermaid = async () => {
        if (!mermaidModule) {
          const m = await import('mermaid')
          mermaidModule = m.default
        }

        const theme = getMermaidTheme()
        // „ÉÜ„Éº„Éû„ÅåÂ§â„Çè„Å£„Åü„Å®„Åç„Å†„Åë initialize „ÇíÂëº„Å∂
        if (theme !== currentMermaidTheme) {
          currentMermaidTheme = theme
          mermaidModule.initialize({
            startOnLoad: false,
            theme,
            flowchart: mermaidFlowchart,
          })
        }

        // ÊèèÁîªÊ∏à„Åø„ÅÆÂ†¥Âêà„ÅÆ„Åø SVG „Çí„ÇØ„É™„Ç¢„Åó„Å¶ÂÜçÊèèÁîª
        mermaidElements.forEach((el) => {
          const original = originalDefinitions.get(el)
          if (original && el.querySelector('svg')) {
            el.removeAttribute('data-processed')
            el.innerHTML = original
          }
        })

        await mermaidModule.run()
      }

      // IntersectionObserver „Åß„Éì„É•„Éº„Éù„Éº„Éà‰ªòËøë„Å´Êù•„Åü„ÇâË™≠„ÅøËæº„Åø
      let mermaidInitiated = false
      if (mermaidElements.length > 0) {
        const observer = new IntersectionObserver(
          (entries) => {
            for (const entry of entries) {
              if (entry.isIntersecting && !mermaidInitiated) {
                mermaidInitiated = true
                observer.disconnect()
                renderMermaid()
              }
            }
          },
          { rootMargin: '200px' },
        )
        mermaidElements.forEach((el) => observer.observe(el))
      }

      const reRenderMermaid = async () => {
        if (!mermaidModule) return
        await renderMermaid()
      }

      // --- „ÉÜ„Éº„Éû„ÉªPDF„É¨„Ç§„Ç¢„Ç¶„ÉàÂà∂Âæ° ---
      ;(function () {
        const themeBtn = document.getElementById('theme-btn')
        const pdfBtn = document.getElementById('pdf-btn')
        const body = document.body
        let printLayoutForced = false

        if (!themeBtn) {
          console.error('Theme button not found')
          return
        }

        const ICONS = { auto: 'üñ•Ô∏è', light: '‚òÄÔ∏è', dark: 'üåô' }
        const CYCLE = ['auto', 'light', 'dark']

        const getSystemTheme = () =>
          window.matchMedia('(prefers-color-scheme: dark)').matches
            ? 'dark'
            : 'light'

        const applyTheme = (mode) => {
          const theme = mode === 'auto' ? getSystemTheme() : mode
          body.setAttribute('data-theme', theme)
          body.setAttribute('data-theme-mode', mode)
          themeBtn.textContent = ICONS[mode]
        }

        // ÂàùÊúüË°®Á§∫Ôºà„Ç§„É≥„É©„Ç§„É≥„Çπ„ÇØ„É™„Éó„Éà„Åß data-theme „ÅØË®≠ÂÆöÊ∏à„ÅøÔºâ
        const currentMode = body.getAttribute('data-theme-mode') || 'auto'
        themeBtn.textContent = ICONS[currentMode]

        // „Ç∑„Çπ„ÉÜ„É†Ë®≠ÂÆöÂ§âÊõ¥„ÅÆÁõ£Ë¶ñÔºàauto „É¢„Éº„ÉâÊôÇ„Å´ËøΩÂæìÔºâ
        window
          .matchMedia('(prefers-color-scheme: dark)')
          .addEventListener('change', () => {
            const mode = body.getAttribute('data-theme-mode')
            if (mode === 'auto') {
              applyTheme('auto')
              reRenderMermaid()
            }
          })

        const setPdfButtonState = (enabled) => {
          if (!pdfBtn) return
          pdfBtn.setAttribute('aria-pressed', enabled ? 'true' : 'false')
        }

        const applyPdfLayout = (enabled) => {
          if (enabled) {
            body.setAttribute('data-layout', 'pdf')
          } else {
            body.removeAttribute('data-layout')
          }
          setPdfButtonState(enabled)
        }

        // PDF„É¨„Ç§„Ç¢„Ç¶„Éà„ÅÆÂæ©ÂÖÉ
        const savedLayout = localStorage.getItem('pdf-layout')
        if (savedLayout === 'enabled') {
          applyPdfLayout(true)
        } else {
          setPdfButtonState(false)
        }

        themeBtn.addEventListener('click', () => {
          const currentMode = body.getAttribute('data-theme-mode') || 'auto'
          const idx = CYCLE.indexOf(currentMode)
          const nextMode = CYCLE[(idx + 1) % CYCLE.length]

          applyTheme(nextMode)
          localStorage.setItem('theme-mode', nextMode)

          reRenderMermaid()
        })

        if (pdfBtn) {
          pdfBtn.addEventListener('click', () => {
            const isPdfLayout = body.getAttribute('data-layout') === 'pdf'
            const nextState = !isPdfLayout

            applyPdfLayout(nextState)
            localStorage.setItem(
              'pdf-layout',
              nextState ? 'enabled' : 'disabled',
            )
            reRenderMermaid()
          })
        } else {
          console.error('PDF button not found')
        }

        window.addEventListener('beforeprint', () => {
          if (body.getAttribute('data-layout') !== 'pdf') {
            applyPdfLayout(true)
            printLayoutForced = true
          }
          // best-effort: Âç∞Âà∑„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÅåÈùûÂêåÊúüÂÆå‰∫Ü„ÇíÂæÖ„Åü„Å™„ÅÑÂ†¥Âêà„Åå„ÅÇ„Çã
          reRenderMermaid()
        })

        window.addEventListener('afterprint', () => {
          if (printLayoutForced) {
            applyPdfLayout(false)
            printLayoutForced = false
          }
          reRenderMermaid()
        })
      })()
    </script>
  </body>
</html>
