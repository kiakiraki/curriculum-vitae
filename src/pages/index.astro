---
import yaml from 'js-yaml'
import fs from 'node:fs'
import path from 'node:path'
import '../styles/resume.css'
import type { CVData } from '../types/cv-data'
import BasicInfo from '../components/cv/BasicInfo.astro'
import Career from '../components/cv/Career.astro'
import Skills from '../components/cv/Skills.astro'
import AITools from '../components/cv/AITools.astro'
import Strengths from '../components/cv/Strengths.astro'
import WorkExperience from '../components/cv/WorkExperience.astro'
import OSSContributions from '../components/cv/OSSContributions.astro'
import NetworkDiagram from '../components/cv/NetworkDiagram.astro'
import Others from '../components/cv/Others.astro'

// Load CV data from YAML
const yamlPath = path.join(process.cwd(), 'src/data/cv-data.yaml')
const yamlContent = fs.readFileSync(yamlPath, 'utf-8')
const cvData = yaml.load(yamlContent) as CVData
---

<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>{cvData.meta.title}</title>
    <meta name="description" content={cvData.meta.description} />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/css/all.min.css" />
  </head>
  <body>
    <div class="theme-toggle">
      <button
        id="theme-btn"
        class="toggle-btn"
        type="button"
        aria-label="Toggle dark mode"
      >
        ðŸŒ™
      </button>
      <button
        id="pdf-btn"
        class="toggle-btn"
        type="button"
        aria-label="Toggle PDF layout"
        aria-pressed="false"
      >
        PDF
      </button>
    </div>

    <main class="container">
      <header class="header">
        <h1>Curriculum-Vitae</h1>
        <p class="update-date">{cvData.meta.updateDate}</p>
      </header>

      <BasicInfo data={cvData.basicInfo} />
      <Career data={cvData.career} />
      <Skills data={cvData.skills} />
      <AITools data={cvData.aiTools} />
      <Strengths data={cvData.strengths} />
      <WorkExperience data={cvData.workExperience} />
      <OSSContributions data={cvData.ossContributions} />
      <NetworkDiagram data={cvData.networkDiagram} />
      <Others data={cvData.others} />
    </main>

    <script>
      import mermaid from 'mermaid'

      const mermaidFlowchart = {
        htmlLabels: true,
        curve: 'cardinal',
      }

      const getMermaidTheme = () => {
        const isPdfLayout = document.body.getAttribute('data-layout') === 'pdf'
        if (isPdfLayout) {
          return 'default'
        }

        return document.body.getAttribute('data-theme') === 'dark'
          ? 'dark'
          : 'default'
      }

      const updateMermaidTheme = () => {
        if (typeof mermaid === 'undefined') {
          return
        }

        mermaid.initialize({
          theme: getMermaidTheme(),
          flowchart: mermaidFlowchart,
        })
      }

      document.addEventListener('DOMContentLoaded', () => {
        mermaid.initialize({
          startOnLoad: true,
          theme: getMermaidTheme(),
          flowchart: mermaidFlowchart,
        })
      })
      ;(function () {
        const themeBtn = document.getElementById('theme-btn')
        const pdfBtn = document.getElementById('pdf-btn')
        const body = document.body
        let printLayoutForced = false

        if (!themeBtn) {
          console.error('Theme button not found')
          return
        }

        const applyTheme = (theme) => {
          body.setAttribute('data-theme', theme)
          themeBtn.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™'
        }

        const setPdfButtonState = (enabled) => {
          if (!pdfBtn) {
            return
          }

          pdfBtn.setAttribute('aria-pressed', enabled ? 'true' : 'false')
        }

        const applyPdfLayout = (enabled) => {
          if (enabled) {
            body.setAttribute('data-layout', 'pdf')
          } else {
            body.removeAttribute('data-layout')
          }

          setPdfButtonState(enabled)
        }

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒ†ãƒ¼ãƒžã‚’èª­ã¿è¾¼ã¿
        const savedTheme = localStorage.getItem('theme')
        if (savedTheme) {
          applyTheme(savedTheme)
        }

        // ã‚·ã‚¹ãƒ†ãƒ ã®è¨­å®šã‚’ç¢ºèª
        if (
          !savedTheme &&
          window.matchMedia &&
          window.matchMedia('(prefers-color-scheme: dark)').matches
        ) {
          applyTheme('dark')
        }

        const savedLayout = localStorage.getItem('pdf-layout')
        if (savedLayout === 'enabled') {
          applyPdfLayout(true)
        } else {
          setPdfButtonState(false)
        }

        themeBtn.addEventListener('click', () => {
          const currentTheme = body.getAttribute('data-theme')
          const newTheme = currentTheme === 'dark' ? 'light' : 'dark'

          applyTheme(newTheme)

          // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
          localStorage.setItem('theme', newTheme)

          // Mermaidãƒ†ãƒ¼ãƒžã®æ›´æ–°
          updateMermaidTheme()
        })

        if (pdfBtn) {
          pdfBtn.addEventListener('click', () => {
            const isPdfLayout = body.getAttribute('data-layout') === 'pdf'
            const nextState = !isPdfLayout

            applyPdfLayout(nextState)
            localStorage.setItem(
              'pdf-layout',
              nextState ? 'enabled' : 'disabled',
            )
            updateMermaidTheme()
          })
        } else {
          console.error('PDF button not found')
        }

        window.addEventListener('beforeprint', () => {
          if (body.getAttribute('data-layout') !== 'pdf') {
            applyPdfLayout(true)
            printLayoutForced = true
          }

          updateMermaidTheme()
        })

        window.addEventListener('afterprint', () => {
          if (printLayoutForced) {
            applyPdfLayout(false)
            printLayoutForced = false
          }

          updateMermaidTheme()
        })
      })()
    </script>
  </body>
</html>
